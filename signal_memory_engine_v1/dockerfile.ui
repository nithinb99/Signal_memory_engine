FROM mambaorg/micromamba:1.5.10-jammy

ENV MAMBA_DOCKERFILE_ACTIVATE=1
WORKDIR /app

COPY environment.yml /tmp/environment.yml
RUN micromamba create -y -f /tmp/environment.yml && micromamba clean -a -y

ARG ENV_NAME=sme310
ENV CONDA_DEFAULT_ENV=${ENV_NAME}
ENV PATH=/opt/conda/envs/${ENV_NAME}/bin:$PATH

# Lock-based install
COPY requirements-lock.txt ./
RUN micromamba run -n ${ENV_NAME} python -m pip install --upgrade pip && \
    micromamba run -n ${ENV_NAME} pip install --no-cache-dir -r requirements-lock.txt

# App files
COPY streamlit_app.py dashboard.py ./

EXPOSE 8501
CMD ["bash", "-lc", "streamlit run streamlit_app.py --server.address=0.0.0.0 --server.port=8501"]
